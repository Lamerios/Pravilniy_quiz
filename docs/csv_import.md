# Импорт CSV статистики в БД

Этот документ фиксирует правила работы с файлом statistics.csv и поведение импортёра.

## Формат исходного файла
- Заголовок присутствует (первая строка).
- Разделитель: запятая.
- Кодировка: UTF-8.
- Дата: M/D/YYYY (например, 11/8/2024).
- Поля в порядке следования:
  1) Дата игры
  2) Название команды
  3) Количество игроков
  4) Номер стола
  5) Раунд 1
  6) Раунд 2
  7) Раунд 3
  8) Раунд 4
  9) Раунд 5
  10) Раунд 6
  11) Раунд 7
  12) Итоговый счет (только для сверки, в БД не записывается)
  13) Место в игре (только для сверки, в БД не записывается)
  14) Источник (идентификатор/название игры)

Особенности значений:
- В раундах допускаются: отрицательные значения и дробные с одним знаком после точки (например, 7.5, 0.5, -1).
- Значения могут быть в кавычках (например, "1,2"); парсер обязан корректно их обрабатывать.

## Сопоставление с сущностями БД
- Игра:
  - name = «Источник»
  - event_date = «Дата игры» (время по умолчанию 20:00, таймзона Europe/Moscow)
  - Правило идентификации одной игры: пара (Источник, Дата игры)
- Шаблон:
  - Все импортируемые игры привязываются к шаблону «Импорт (7 раундов)» без ограничений max_score
  - Если шаблона нет — создать автоматически
- Команда:
  - Поиск по названию с trim
  - Case-insensitive сопоставление — только если различие в регистре (BIMO = BiMO)
  - Опечатки объединяются вручную через словарь синонимов (например, «СНТ Прокшино» = «СНТ Прошкино»); разные команды типа «Не смотрите наверх» и «Не смотрите на Короля» не объединяются
- Участники игры:
  - participants_count = «Количество игроков». Если 0 — заменить на 2. Отрицательные/нецелые — округлить до целого и минимум 2
  - table_number = «Номер стола» как строка без нормализации (допускаются «Бар», «1а», «1,2», «бронь» и т.п.)
- Баллы по раундам (7 колонок «Раунд 1…7»):
  - Парсить как number; пустые значения трактовать как 0
  - Десятичный разделитель — точка
  - Отрицательные и дробные допустимы (1 знак после запятой)
- Итог/место из CSV:
  - Используются только для сверки и в БД не записываются (итог и места считаются движком по нашим правилам тай-брейка)

## Бизнес-правила импорта
- Группировка строк в одну игру: (Источник, Дата игры)
- Дубликаты одной команды внутри одной игры: если встречается несколько строк — брать последнюю по порядку в файле
- «Заглушки»/пустые записи (например, «Свободный стол» или все раунды = 0): пропускать
- Валидации по max_score не выполнять (шаблон без ограничений)

## Отчёт и логирование
- По завершении импорта формируется файл отчёта reports/import-YYYYMMDD.csv со случаями:
  - расхождение «Итоговый счёт/Место» (CSV) с пересчитанными значениями;
  - пропущенные строки (заглушки/невалидные);
  - произведённые нормализации (например, participants_count 0→2, дубликаты и т.п.)

## CLI и сценарий запуска
- Команда: npm run import:csv -- --file path/to/statistics.csv
- Алгоритм работы импортёра:
  1) Удостовериться, что существует шаблон «Импорт (7 раундов)»; при отсутствии создать
  2) Считать CSV, сгруппировать строки по (Источник, Дата игры)
  3) Для каждой группы создать игру (если её нет) и участников
  4) Для каждой строки создать/обновить команду по правилам сопоставления названий
  5) По участнику записать баллы по 7 раундам; дубликаты внутри игры — перезаписывать последней строкой
  6) Сформировать отчёт о расхождениях и пропусках

## Примечания
- Для дат использовать парсинг M/D/YYYY с установкой времени 20:00 (Europe/Moscow)
- Операции выполняются транзакционно в разрезе одной игры, чтобы исключить частичный импорт
